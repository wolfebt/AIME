<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI.me Pair Writer</title>
    <meta name="author" content="Wolfe.bt@TangentLLC">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 1. Load React libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 2. Load Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Load Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 25px 25px;
            color: #e6edf3;
        }

        .glass-panel {
            background-color: rgba(22, 27, 34, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 148, 158, 0.2);
            border-radius: 0.75rem;
            animation: fadeIn 0.5s ease-out forwards;
        }

        .main-tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            color: #8b949e;
            transition: all 0.2s;
        }
        .main-tab-btn.active {
            color: #2563eb; /* Dark Blue */
            border-bottom-color: #2563eb; /* Dark Blue */
        }
        .main-tab-btn:not(.active):hover {
            color: #c9d1d9;
            border-bottom-color: rgba(139, 148, 158, 0.3);
        }
        .nav-btn-side {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            color: #8b949e;
        }
        .nav-btn-side.active {
            background-color: rgba(30, 58, 138, 0.1);
            color: #2563eb; /* Dark Blue */
        }
        .nav-btn-side:not(.active):hover {
            background-color: rgba(139, 148, 158, 0.1);
            color: #c9d1d9;
        }
        
        .btn-primary {
            background-color: #4c1d95; /* Dark Purple */
            color: white;
            border: 1px solid #2563eb; /* Thin Blue Border */
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(76, 29, 149, 0.4);
            font-weight: 600;
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(76, 29, 149, 0.6);
            background-color: #5b21b6; /* Lighter purple on hover */
            border-color: #3b82f6; /* Brighter blue on hover */
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: rgba(139, 148, 158, 0.15);
            color: #c9d1d9;
            transition: background-color 0.3s;
            border: 1px solid rgba(139, 148, 158, 0.2);
        }
        .btn-secondary:hover:not(:disabled) { 
            background-color: rgba(139, 148, 158, 0.3);
            border-color: rgba(139, 148, 158, 0.4);
        }
        .editable-title {
            outline: none;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s;
            padding: 0.1rem 0.25rem;
            font-size: clamp(2rem, 5vw, 3rem); /* Responsive font size */
            line-height: 1.2;
        }
        .editable-title:focus {
            border-bottom-color: #3b82f6; /* Brighter blue on focus */
        }
        .asset-card {
            background-color: rgba(139, 148, 158, 0.1);
            border: 1px solid rgba(139, 148, 158, 0.2);
            transition: all 0.2s;
        }
        .asset-card:hover {
            border-color: #2563eb; /* Dark Blue */
            background-color: rgba(37, 99, 235, 0.1);
        }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363d; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: #e6edf3; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #1e3a8a; } /* Dark Blue */
        input:checked + .slider:before { transform: translateX(14px); }
        
        /* Accordion Styles */
        .accordion-section {
            background-color: rgba(36, 41, 47, 0.7);
            border: 1px solid rgba(139, 148, 158, 0.2);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .accordion-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #e6edf3;
            background-color: rgba(139, 148, 158, 0.1);
            cursor: pointer;
        }
        .accordion-section.open .accordion-header span {
            color: #2563eb; /* Dark Blue */
        }
        .accordion-header svg { 
            transition: transform 0.2s;
            color: #a78bfa;
        }
        .accordion-section.open .accordion-header svg { transform: rotate(180deg); }
        .accordion-content { padding: 1.5rem; }

        /* Input Field Styles */
        .tool-input {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #e6edf3;
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            min-height: 52px; /* Uniform height for all fields */
        }
        .tool-input:focus {
            outline: none;
            border-color: #1e3a8a; /* Dark Blue */
            box-shadow: 0 0 10px rgba(30, 58, 138, 0.3);
        }
        .tool-input::placeholder { color: #484f58; }
        
        .ai-toggle-btn {
            background-color: #21262d;
            border: 2px solid #30363d;
            border-radius: 50%;
            width: 1.5rem; height: 1.5rem; flex-shrink: 0;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 120ms ease-in-out;
        }
        .ai-toggle-btn::before {
            content: "";
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            background-color: #e6edf3;
        }
        .ai-toggle-btn.active {
            background-color: #1e3a8a; /* Dark Blue */
            border-color: #1e3a8a; /* Dark Blue */
            box-shadow: 0 0 10px rgba(30, 58, 138, 0.5);
        }
        .ai-toggle-btn.active::before {
            transform: scale(1);
        }
        .action-btn {
            background-color: rgba(139, 148, 158, 0.1);
            color: #8b949e;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background-color: rgba(139, 148, 158, 0.2);
            color: #c9d1d9;
        }
        .reiterate-select-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #484f58;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .reiterate-select-btn:hover {
            border-color: #1e3a8a; /* Dark Blue */
        }
        .reiterate-select-btn.selected {
            background-color: #1e3a8a; /* Dark Blue */
            border-color: #1e3a8a; /* Dark Blue */
        }
        .reiterate-select-btn.selected svg {
            stroke: white;
        }
        .content-editable-wrapper:focus-within {
             outline: 2px solid #1e3a8a; /* Dark Blue */
            box-shadow: 0 0 10px rgba(30, 58, 138, 0.3);
            border-radius: 0.375rem;
        }
        .content-editable-wrapper[data-mode="lock"] .content-editable-div,
        .content-editable-wrapper[data-mode="ai-edit"] .content-editable-div {
            cursor: text;
        }
        .content-editable-wrapper[data-mode="lock"]:focus-within,
         .content-editable-wrapper[data-mode="ai-edit"]:focus-within {
            outline: none;
            box-shadow: none;
        }


        @keyframes colorCycle {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes glowPulse {
            0%, 100% { filter: blur(10px); opacity: 0; }
            12.5% { filter: blur(12px); opacity: 0.3; }
            25% { filter: blur(15px); opacity: 0.6; }
            37.5% { filter: blur(20px); opacity: 0.9; }
            50% { filter: blur(25px); opacity: 1; }
            62.5% { filter: blur(20px); opacity: 0.9; }
            75% { filter: blur(15px); opacity: 0.6; }
            87.5% { filter: blur(12px); opacity: 0.3; }
        }
        .title-animated-gradient {
            position: relative;
            background: linear-gradient(90deg, #3b0764, #5b21b6, #1e3a8a, #1e293b, #1e3a8a, #5b21b6, #3b0764);
            background-size: 400% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: colorCycle 10s ease infinite;
        }
        .title-animated-gradient::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            z-index: -1;
            background: linear-gradient(90deg, #3b0764, #5b21b6, #1e3a8a, #1e293b, #1e3a8a, #5b21b6, #3b0764);
            background-size: 400% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: colorCycle 10s ease infinite, glowPulse 6s ease-in-out infinite;
        }
        .resize-handle {
            width: 12px;
            cursor: col-resize;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            position: relative;
        }
         .resize-handle:hover, .resize-handle.resizing {
             background-color: rgba(139, 92, 246, 0.2);
         }
        .resize-handle::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 10px;
            bottom: 10px;
            width: 2px;
            background-color: rgba(139, 92, 246, 0.5);
            transform: translateX(-50%);
            border-radius: 1px;
        }
        .resize-handle::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 12px;
            width: 6px;
            height: 6px;
            background-color: rgba(139, 92, 246, 1);
            border-radius: 50%;
            transform: translateX(-50%);
        }

        .gem-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .gem-button {
            display: inline-flex;
            align-items: center;
            background-color: rgba(139, 148, 158, 0.1);
            border: 1px solid rgba(139, 148, 158, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            line-height: 1;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gem-button:hover {
            border-color: #2563eb;
            background-color: rgba(37, 99, 235, 0.1);
        }

        .gem-button .label {
            color: #8b949e;
            margin-right: 0.375rem;
        }

        .gem-button .value {
            color: #e6edf3;
        }
        
        .ai-action-toolbar {
            position: absolute;
            z-index: 100;
            background-color: rgba(22, 27, 34, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(139, 148, 158, 0.3);
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .ai-action-toolbar button {
            background-color: rgba(139, 148, 158, 0.15);
            color: #c9d1d9;
            border: 1px solid rgba(139, 148, 158, 0.2);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
         .ai-action-toolbar button:hover {
            background-color: rgba(139, 148, 158, 0.3);
            border-color: rgba(139, 148, 158, 0.4);
        }

        .editor-mode-switch {
            display: flex;
            align-items: center;
            background-color: transparent;
            border: 1px solid #5b21b6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .editor-mode-switch button:not(:first-child) {
            border-left: 1px solid #5b21b6;
        }

        .loader {
            border: 3px solid #30363d;
            border-top: 3px solid #5b21b6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Config Data ---
        const storyTraitsConfig = {
            brainstormType: { 
                title: 'Brainstorm Type', 
                options: { 
                    'Creative Exploration': ['Concept Expansion', 'What If Scenarios', 'Free Writing', 'Reverse Brainstorming'],
                    'Structured Ideation': ['SCAMPER', 'Attribute Listing', 'Morphological Analysis', 'Lotus Blossom Technique'],
                    'Analytical Frameworks': ['SWOT Analysis', 'Six Thinking Hats'],
                    'Marketing & Concepts': ['Marketing Angles'],
                    'Guided Approach': ['Socratic Dialogue'],
                    'Custom': ['Other...']
                } 
            },
            targetAudience: { title: 'Target Audience', options: { 'Youth': ['Children', 'Teen', 'Young Adult'], 'Adult': ['Mature', 'Graphic'], 'Technical': ['Academic'], 'Custom': ['Other...'] } },
            outlineStructure: { title: 'Outline Structure', options: { 'Classic Structures': ['Three-Act Structure', "The Hero's Journey", 'Five-Act Structure'], 'Novel Writing': ['Save the Cat Beat Sheet', 'Snowflake Method', 'Fichtean Curve'], 'Custom': ['Other...'] } },
            writingFormat: { title: 'Writing Format', options: { 'Prose & Narrative': ['Novel / Book Chapter', 'Short Story', 'Flash Fiction'], 'Scripts & Performance': ['Screenplay Scene', 'Dialogue Only', 'Stage Play Scene', 'Comic Book Script'], 'Custom': ['Other...'] } },
            writingStyle: { 
                title: 'Writing Style', 
                options: {
                    'Common Tones': ['Professional', 'Casual', 'Humorous', 'Formal', 'Serious'],
                    'Literary Styles': ['Poetic', 'Minimalist', 'Journalistic', 'Satirical', 'Gritty / Noir'],
                    'Genre Styles': ['Epic Fantasy', 'Hard Sci-Fi', 'Cozy Mystery', 'Young Adult Dystopian'],
                    'Custom': ['Other...']
                }
            },
            plot: { title: 'Plot', options: { 'Structures': ['Linear', 'Episodic', 'Parallel', 'Circular', 'Flashback-driven'], 'Custom': ['Other...'] } },
            conflict: { title: 'Conflict', options: { 'Types': ['Character vs. Self', 'Character vs. Character', 'Character vs. Society', 'Character vs. Nature'], 'Custom': ['Other...'] } },
            theme: { title: 'Theme', options: { 'Ideas': ['Love vs. Hate', 'Good vs. Evil', 'Coming of Age', 'Redemption', 'Humanity vs. Technology', 'Survival'], 'Custom': ['Other...'] } },
            pointOfView: { title: 'Point of View', options: { 'Perspectives': ['First Person', 'Second Person', 'Third Person Limited', 'Third Person Omniscient'], 'Custom': ['Other...'] } },
            tone: { title: 'Tone', options: { 'Attitudes': ['Serious', 'Humorous', 'Satirical', 'Suspenseful', 'Formal', 'Casual', 'Melancholy'], 'Custom': ['Other...'] } },
            symbolism: { title: 'Symbolism', options: { 'Archetypes': ['Light vs. Dark', 'The Journey', 'Seasonal Cycles', 'Water (Purity/Rebirth)'], 'Custom': ['Other...'] } }
        };

        const personaFieldsConfig = {
            name: { label: 'Persona Name', type: 'text', placeholder: 'e.g., Alistair Croft' },
            genre: { label: 'Genre', type: 'text', placeholder: 'e.g., Sci-Fi, Fantasy' },
            'core-description': { label: 'Core Description', type: 'textarea', placeholder: 'A high-level summary...' },
            backstory: { label: 'Backstory', type: 'textarea', placeholder: 'Detail their history...' },
            motivations: { label: 'Motivations', type: 'textarea', placeholder: 'What drives them?' },
            goals: { label: 'Goals', type: 'textarea', placeholder: 'Short-term and long-term goals.' },
            personality: { label: 'Personality', type: 'textarea', placeholder: 'e.g., Witty, cautious...' },
            voiceType: { label: 'Voice Type', type: 'text', placeholder: 'e.g., Deep and gravelly...' },
            weaknesses: { label: 'Weaknesses', type: 'textarea', placeholder: 'e.g., Fear of heights' },
            skills: { label: 'Skills', type: 'text', placeholder: 'e.g., Lockpicking...' },
            abilities: { label: 'Abilities', type: 'text', placeholder: 'e.g., Minor pyromancy...' },
            equipment: { label: 'Equipment', type: 'textarea', placeholder: 'What items do they carry?' },
            relationships: { label: 'Relationships', type: 'textarea', placeholder: 'Family, friends, rivals...' },
            notes: { label: 'Notes', type: 'textarea', placeholder: 'Any other important details...' },
            gender: { label: 'Gender Representation', type: 'text', placeholder: 'e.g., Female, Male...' },
            build: { label: 'Build', type: 'text', placeholder: 'e.g., Athletic, Slender...' },
            hair: { label: 'Hair Color & Style', type: 'text', placeholder: 'e.g., Long blonde hair...' },
            eyes: { label: 'Eye Color & Shape', type: 'text', placeholder: 'e.g., Piercing blue eyes...' },
            clothing: { label: 'Clothing', type: 'textarea', placeholder: 'e.g., Worn leather armor...' },
            expression: { label: 'Expression / Mood', type: 'textarea', placeholder: 'e.g., Determined, smiling...' },
            background: { label: 'Background / Setting', type: 'textarea', placeholder: 'e.g., Bustling city street...' },
            'other-details': { label: 'Other Details (Race, etc.)', type: 'textarea', placeholder: 'e.g., Scars, tattoos...' },
            'negative-prompts': { label: 'NEGATIVE PROMPTS', type: 'textarea', placeholder: 'e.g., hats, glasses...' }
        };

        const sceneFieldsConfig = {
            name: { label: 'Scene Name', type: 'text', placeholder: 'e.g., The Whispering Caverns' },
            genre: { label: 'Genre', type: 'text', placeholder: 'e.g., High Fantasy, Cyberpunk' },
            overview: { label: 'Overview', type: 'textarea', placeholder: 'A high-level summary of the scene...' },
            atmosphere: { label: 'Atmosphere / Mood', type: 'textarea', placeholder: 'e.g., Oppressive and tense...' },
            exterior: { label: 'Exterior Description', type: 'textarea', placeholder: 'Describe the scene from the outside...' },
            interior: { label: 'Interior Description', type: 'textarea', placeholder: 'Describe the scene from the inside...' },
            history: { label: 'History', type: 'textarea', placeholder: 'What is the history of this location?' },
            time_of_day: { label: 'Time of Day', type: 'text', placeholder: 'e.g., Sunrise, Night' },
            weather: { label: 'Weather', type: 'text', placeholder: 'e.g., Sunny, Raining' },
            architectural_style: { label: 'Architectural Style', type: 'text', placeholder: 'e.g., Gothic, Modern' },
            other_details: { label: 'Other Details', type: 'textarea', placeholder: 'e.g., specific flora...' },
            negative_prompts_scene: { label: 'NEGATIVE PROMPTS', type: 'textarea', placeholder: 'e.g., people, vehicles...' }
        };

        const worldFieldsConfig = {
            name: { label: 'Setting Name', type: 'text', placeholder: 'e.g., The Clockwork City' },
            genre: { label: 'Genre', type: 'text', placeholder: 'e.g., Steampunk, High Fantasy' },
            timePeriod: { label: 'Time Period / Era', type: 'text', placeholder: 'e.g., Victorian Era, Far Future' },
            corePremise: { label: 'Core Premise', type: 'textarea', placeholder: 'A one-sentence summary...' },
            geography: { label: 'Geography & Topography', type: 'textarea', placeholder: 'e.g., Floating islands, vast deserts...' },
            climate: { label: 'Climate & Weather', type: 'textarea', placeholder: 'e.g., Perpetual twilight, acid rain...' },
            floraFauna: { label: 'Flora & Fauna', type: 'textarea', placeholder: 'e.g., Carnivorous plants, metallic birds...' },
            population: { label: 'Population & Demographics', type: 'textarea', placeholder: 'e.g., A melting pot of elves and dwarves...' },
            government: { label: 'Government & Politics', type: 'textarea', placeholder: 'e.g., Corporate technocracy, monarchy...' },
            economy: { label: 'Economy & Trade', type: 'textarea', placeholder: 'e.g., Barter system, post-scarcity...' },
            culture: { label: 'Arts & Culture', type: 'textarea', placeholder: 'e.g., Dominant art forms, aesthetics...' },
            technology: { label: 'Technology Level', type: 'textarea', placeholder: 'e.g., Stone Age, Information Age...' },
            magic: { label: 'Magic System', type: 'textarea', placeholder: 'e.g., Source, availability, rules, costs...' },
            religion: { label: 'Religion & Cosmology', type: 'textarea', placeholder: 'e.g., Beliefs about the universe, deities...' },
            history: { label: 'Key Historical Events', type: 'textarea', placeholder: 'e.g., Major wars, discoveries, cataclysms...' },
            lore: { label: 'Myths & Legends', type: 'textarea', placeholder: 'e.g., Foundational stories about heroes, monsters...' },
            architectural_style_world: { label: 'Architectural Style', type: 'text', placeholder: 'e.g., Gothic, Modern, Alien' },
            time_of_day_world: { label: 'Time of Day', type: 'text', placeholder: 'e.g., Sunrise, Twin Moons Night' },
            weather_vis: { label: 'Weather', type: 'text', placeholder: 'e.g., Light snow, heavy fog' },
            other_details_vis: { label: 'Other Visual Details', type: 'textarea', placeholder: 'e.g., Glowing crystals, strange colors...' },
            negative_prompts_setting: { label: 'NEGATIVE PROMPTS', type: 'textarea', placeholder: 'e.g., people, vehicles, text...' }
        };

        // --- Custom Hooks ---
        function useHistoryState(initialState) {
            const [index, setIndex] = useState(0);
            const [history, setHistory] = useState([initialState]);

            const setState = (action, overwrite = false) => {
                const newState = typeof action === 'function' ? action(history[index]) : action;
                if (overwrite) {
                    const newHistory = [...history];
                    newHistory[index] = newState;
                    setHistory(newHistory);
                } else {
                    const updatedHistory = history.slice(0, index + 1);
                    setHistory([...updatedHistory, newState]);
                    setIndex(index + 1);
                }
            };

            const undo = () => index > 0 && setIndex(index - 1);
            const redo = () => index < history.length - 1 && setIndex(index + 1);

            return [history[index], setState, undo, redo, index > 0, index < history.length - 1];
        };

        function useOnClickOutside(ref, handler) {
            useEffect(() => {
                const listener = (event) => {
                    if (!ref.current || ref.current.contains(event.target)) {
                        return;
                    }
                    handler(event);
                };
                document.addEventListener("mousedown", listener);
                document.addEventListener("touchstart", listener);
                return () => {
                    document.removeEventListener("mousedown", listener);
                    document.removeEventListener("touchstart", listener);
                };
            }, [ref, handler]);
        }


        // --- NEW Resizable Columns Component ---
        const ResizableColumns = ({ leftColumn, rightColumn, initialLeftWidth = 33.33 }) => {
            const [leftWidth, setLeftWidth] = useState(initialLeftWidth);
            const [isResizing, setIsResizing] = useState(false);
            const containerRef = useRef(null);

            const handleMouseDown = (e) => {
                e.preventDefault();
                setIsResizing(true);
            };

            const handleMouseUp = () => {
                setIsResizing(false);
            };

            const handleMouseMove = (e) => {
                if (!isResizing || !containerRef.current) return;

                const containerRect = containerRef.current.getBoundingClientRect();
                const newLeftWidthPx = e.clientX - containerRect.left;
                let newLeftWidthPercent = (newLeftWidthPx / containerRect.width) * 100;
                
                // Enforce 20% to 80% constraints
                newLeftWidthPercent = Math.max(20, Math.min(80, newLeftWidthPercent));

                setLeftWidth(newLeftWidthPercent);
            };

            useEffect(() => {
                if (isResizing) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                } else {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isResizing, handleMouseMove, handleMouseUp]);


            return (
                <div ref={containerRef} className="flex w-full h-full">
                    <div style={{ width: `${leftWidth}%` }}>
                        {leftColumn}
                    </div>
                    <div
                        className={`resize-handle ${isResizing ? 'resizing' : ''}`}
                        onMouseDown={handleMouseDown}
                    >
                    </div>
                    <div style={{ width: `${100 - leftWidth}%`, paddingLeft: '2rem' }}>
                         {rightColumn}
                    </div>
                </div>
            );
        };


        // --- Reusable SVG Icon Components ---
        const SettingsIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0l-.1.41a2 2 0 01-2.23 1.52l-.4-.1a2 2 0 00-2.2 2.2l.1.4a2 2 0 01-1.52 2.23l-.41.1c-1.56.38-1.56 2.6 0 2.98l.41.1a2 2 0 011.52 2.23l-.1.4a2 2 0 002.2 2.2l.4-.1a2 2 0 012.23 1.52l.1.41c.38 1.56 2.6 1.56 2.98 0l.1-.41a2 2 0 012.23-1.52l.4.1a2 2 0 002.2-2.2l-.1-.4a2 2 0 011.52-2.23l.41-.1c-1.56-.38-1.56-2.6 0-2.98l-.41-.1a2 2 0 01-1.52-2.23l.1-.4a2 2 0 00-2.2-2.2l-.4.1a2 2 0 01-2.23-1.52l-.1-.41zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" /></svg> );
        const FileIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clipRule="evenodd" /></svg> );
        const ImageIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clipRule="evenodd" /></svg> );
        const ChevronDownIcon = () => ( <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg> );
        const SendIcon = () => ( <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"></path></svg>);
        const HistoryIcon = () => ( <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8V12L14.5 14.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"></path></svg>);
        const FileActionIcon = () => (<svg className="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>);
        const DownloadIcon = () => ( <svg className="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" /></svg>);
        const CloseIcon = () => (<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>);
        const PrintIcon = () => ( <svg className="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clipRule="evenodd" /></svg>);
        const ReiterateIcon = () => (<svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h5M20 20v-5h-5" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 9a9 9 0 0114.13-5.26M20 15a9 9 0 01-14.13 5.26" /></svg>);
        const CheckIcon = () => (<svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>);
        const UndoIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 15l-3-3m0 0l3-3m-3 3h8a5 5 0 000-10H9" /></svg>);
        const RedoIcon = () => (<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 15l3-3m0 0l-3-3m3 3H5a5 5 0 000 10h1" /></svg>);


        // --- Main App Component ---
        function App() {
            const [activeMainTab, setActiveMainTab] = useState('story');
            const [notification, setNotification] = useState(null);
            const [fileActionState, setFileActionState] = useState({ isOpen: false, title: '', contentType: '', contentData: null });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [apiKey, setApiKey] = useState('');

            useEffect(() => {
                const storedKey = localStorage.getItem('gemini-api-key');
                if (storedKey) {
                    setApiKey(storedKey);
                }
            }, []);

            const handleSaveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini-api-key', key);
                setIsSettingsOpen(false);
                setNotification({ message: 'API Key saved!', type: 'success' });
            };
            
            const callGeminiAPI = async (prompt, setLoading, expectJson = false) => {
                if (!apiKey) {
                    setNotification({ message: 'API Key is missing. Please add it in Settings.', type: 'error' });
                    setIsSettingsOpen(true);
                    return null;
                }
                setLoading(true);

                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            setLoading(false);
                            if (expectJson) {
                                try {
                                    // Clean the response from markdown code blocks
                                    const cleanedJsonString = textResponse.replace(/```json\n|```/g, '').trim();
                                    return JSON.parse(cleanedJsonString);
                                } catch (e) {
                                     console.error("Failed to parse JSON:", e, "Raw response:", textResponse);
                                     setNotification({ message: "AI returned invalid format. Please try again.", type: 'error' });
                                     return null;
                                }
                            }
                            return textResponse;
                        }

                        const errorData = await response.json().catch(() => ({}));
                        if (errorData.error && errorData.error.message.includes("API key not valid")) {
                            setNotification({ message: "Error: API Key is not valid. Please check settings.", type: "error" });
                            setIsSettingsOpen(true);
                            setLoading(false);
                            return null;
                        }

                        if (response.status === 503 || response.status === 429) { // Service Unavailable or Too Many Requests
                            if (i < maxRetries - 1) {
                                await new Promise(resolve => setTimeout(resolve, delay));
                                delay *= 2; // Exponential backoff
                                continue;
                            }
                        }
                        
                        setLoading(false);
                        throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                    } catch (e) {
                         if (i === maxRetries - 1) {
                             console.error(e);
                             setNotification({ message: `API Error: ${e.message}`, type: 'error'});
                             setLoading(false);
                             return null;
                         }
                    }
                }
            };

            const clearNotification = () => setNotification(null);

            const openFileActionModal = (title, contentType, contentData) => {
                setFileActionState({ isOpen: true, title, contentType, contentData });
            };

            const closeFileActionModal = () => {
                setFileActionState({ isOpen: false, title: '', contentType: '', contentData: null });
            };

            const Notification = ({ notification, onClear }) => {
                useEffect(() => {
                    if (notification) {
                        const timer = setTimeout(() => {
                            onClear();
                        }, 5000); // Auto-dismiss after 5 seconds
                        return () => clearTimeout(timer);
                    }
                }, [notification, onClear]);

                if (!notification) return null;

                const bgColor = notification.type === 'error' ? 'bg-red-500/20 border-red-500/50' : 'bg-blue-800/20 border-blue-700/50';
                const textColor = notification.type === 'error' ? 'text-red-400' : 'text-blue-300';

                return (
                    <div className={`fixed bottom-8 right-8 glass-panel p-4 rounded-lg flex items-center gap-4 z-50 ${bgColor}`} style={{animation: 'slideInUp 0.5s ease-out forwards'}}>
                        <p className={`font-semibold ${textColor}`}>{notification.message}</p>
                        <button onClick={onClear} className="text-gray-400 hover:text-white">
                            <CloseIcon />
                        </button>
                    </div>
                );
            };

            const Header = () => ( 
                <header className="text-center mb-4 relative pt-4">
                    <h1 className="inline-block text-5xl font-black tracking-wide title-animated-gradient" data-text="AI.me Pair Writer">AI.me Pair Writer</h1>
                    <p className="text-lg text-gray-400 mt-2">AI Pair Author</p>
                    <button onClick={() => setIsSettingsOpen(true)} className="absolute top-4 right-0 p-2 rounded-lg btn-secondary" title="Settings"><SettingsIcon /></button>
                </header> 
            );

            const MainTabs = ({ activeTab, setActiveTab }) => (
                <div className="border-b border-gray-700">
                    <nav className="-mb-px flex space-x-6 justify-center" aria-label="Tabs">
                        <button onClick={() => setActiveTab('story')} className={`main-tab-btn ${activeTab === 'story' ? 'active' : ''}`}>Story</button>
                        <button onClick={() => setActiveTab('elements')} className={`main-tab-btn ${activeTab === 'elements' ? 'active' : ''}`}>Elements</button>
                    </nav>
                </div> 
            );
            
            const StoryView = ({ setNotification, onOpenFileActionModal, callGeminiAPI }) => {
                const [storyTitle, setStoryTitle] = useState('Untitled Story');
                const [activeStage, setActiveStage] = useState('brainstorm');
                const [storyData, setStoryData] = useState({
                    brainstorm: { prompt: '', content: null, lastPrompt: null, numIdeas: 4, swot: {s: '', w: '', o: '', t: ''}, sixHats: { white: { e: true, g: '', p: 'default'}, red: { e: true, g: '', p: 'default'}, black: { e: true, g: '', p: 'default'}, yellow: { e: true, g: '', p: 'default'}, green: { e: true, g: '', p: 'default'}, blue: { e: true, g: '', p: 'default'} } },
                    outline: { prompt: '', content: null, lastPrompt: null },
                    treatment: { prompt: '', content: null, lastPrompt: null },
                });
                 const [activeElements, setActiveElements] = useState({
                    persona: {}, scene: {}, world: {}
                });
                const [isLoading, setIsLoading] = useState(false);
                 const [storyTraits, setStoryTraits] = useState({
                    brainstormType: 'Concept Expansion', targetAudience: '', outlineStructure: '',
                    writingFormat: '', writingStyle: '', plot: '',
                    conflict: '', theme: '', pointOfView: '', tone: '', symbolism: '',
                    negativePrompts: ''
                });

                const [storyAssets, setStoryAssets] = useState([]);
                const [writeContent, setWriteContent, undo, redo, canUndo, canRedo] = useHistoryState('');
                
                const [isBrainstormModalOpen, setIsBrainstormModalOpen] = useState(false);
                const [selectedIdea, setSelectedIdea] = useState(null);

                const stages = [
                    { id: 'brainstorm', name: 'Brainstorm' },
                    { id: 'outline', name: 'Outline' },
                    { id: 'treatment', name: 'Treatment' },
                    { id: 'write', name: 'Write' }
                ];

                const handleUpdateStoryData = (stageId, newContent, lastPrompt) => {
                    setStoryData(prev => ({ 
                        ...prev, 
                        [stageId]: { ...prev[stageId], content: newContent, lastPrompt: lastPrompt || prev[stageId].lastPrompt }
                    }));
                };
                 const handleBrainstormInputChange = (field, value) => {
                     setStoryData(prev => ({...prev, brainstorm: {...prev.brainstorm, [field]: value }}));
                 };
                
                const getAssetContextForAI = (assets) => {
                    const includedAssets = assets.filter(asset => asset.included);
                    if (includedAssets.length === 0) return "";

                    let context = "\n\n--- ASSETS CONTEXT ---\n";
                    includedAssets.forEach(asset => {
                        context += `\n[File: ${asset.name}]\n`;
                        if (asset.type === 'json') {
                            context += `Content: ${JSON.stringify(asset.content, null, 2)}\n`;
                        } else {
                            context += `Content: ${asset.content}\n`;
                        }
                    });
                    context += "--- END ASSETS CONTEXT ---\n";
                    return context;
                };

                const handleGenerateBrainstorm = async () => {
                    const { prompt: userPrompt, numIdeas, swot, sixHats } = storyData.brainstorm;
                    const assetContext = getAssetContextForAI(storyAssets);
                    const activeTraits = Object.entries(storyTraits)
                        .filter(([key, value]) => value && value.trim() !== '' && key !== 'negativePrompts')
                        .map(([key, value]) => `${storyTraitsConfig[key]?.title}: ${value}`)
                        .join('\n     - ');

                    const getSystemPromptForStyle = (style) => {
                        switch(style) {
                            case 'SCAMPER':
                                return 'You are an innovation consultant. Apply the SCAMPER framework to the user\'s concept. For each letter (Substitute, Combine, Adapt, Modify, Put to another use, Eliminate, Reverse), provide a distinct, creative idea.';
                            case 'Reverse Brainstorming':
                                return 'You are a problem-solving expert. For the user\'s goal, first identify potential problems or ways to make the goal harder to achieve. Then, for each problem, brainstorm a creative solution or narrative twist.';
                            case 'Lotus Blossom Technique':
                                 return 'You are an idea expansion expert. Using the Lotus Blossom technique, take the central idea and generate 8 surrounding ideas or themes. Then, use each of those as a new center to generate more ideas. Present the result in a structured, clear format.';
                            case 'SWOT Analysis':
                                return 'You are a business and narrative strategist. Conduct a SWOT analysis based on the user\'s inputs and the core concept. Synthesize the analysis to generate actionable story concepts.';
                             case 'Six Thinking Hats':
                                return 'You are an expert facilitator using Edward de Bono\'s Six Thinking Hats method. Analyze the user\'s concept from the perspective of each enabled hat, adopting any specified personas. Then, provide a summary and generate concepts based on the multi-faceted analysis.';
                            default:
                                return 'You are a master storyteller and creative strategist. Your task is to generate unique, detailed, and compelling story concepts based on the provided creative brief.';
                        }
                    };
                    
                    const systemPrompt = getSystemPromptForStyle(storyTraits.brainstormType);
                    
                    let brief = `
                        CREATIVE BRIEF FOR STORY CONCEPT GENERATION

                        1. CORE MANDATE:
                        ${userPrompt}

                        2. WORLD BIBLE (Source of Truth):
                           - Included Assets: ${assetContext || 'None'}

                        3. DIRECTOR'S NOTES (Stylistic Guidance):
                           - Brainstorm Style: ${storyTraits.brainstormType}
                           - Guidance Traits:
                             - ${activeTraits || 'None'}
                    `;

                    if (storyTraits.brainstormType === 'SWOT Analysis') {
                        brief += `
                        4. SWOT INPUTS:
                           - Strengths: ${swot.s}
                           - Weaknesses: ${swot.w}
                           - Opportunities: ${swot.o}
                           - Threats: ${swot.t}
                        `;
                    }
                    if (storyTraits.brainstormType === 'Six Thinking Hats') {
                         const personaAssets = storyAssets.filter(a => a.type === 'json' && a.content?.name);
                         const enabledHats = Object.entries(sixHats).filter(([_, data]) => data.e).map(([hat, data]) => {
                            const personaName = data.p === 'default' ? 'a neutral AI perspective' : `the persona of '${data.p}'`;
                            return `- ${hat.charAt(0).toUpperCase() + hat.slice(1)} Hat: Adopt ${personaName}. User guidance: "${data.g}"`;
                         }).join('\n');
                         brief += `
                         4. SIX HATS INPUTS:
                         ${enabledHats}
                         `;
                    }


                    brief += `
                        5. MANDATORY CONSTRAINTS:
                           - Negative Prompts: ${storyTraits.negativePrompts || 'None'}

                        6. TASK:
                        Generate exactly ${numIdeas} distinct concepts according to the chosen brainstorm style.

                        7. OUTPUT FORMAT:
                        Your entire response MUST be a single, valid JSON array of objects with keys "title", "summary", and "fullConcept". Do not include any text outside of the JSON array. For structured techniques, format the "fullConcept" with clear markdown headings.
                    `;

                    const fullPrompt = `${systemPrompt}\n\n${brief}`;

                    const fullPromptForSaving = {
                        title: storyTitle, type: 'story-brainstorm', timestamp: new Date().toISOString(), fullPrompt: fullPrompt,
                        components: { userGuidance: userPrompt, storyTraits, assetContext, numIdeas, swot, sixHats }
                    };

                    const response = await callGeminiAPI(fullPrompt, setIsLoading, true); // Expect JSON
                    if (response && Array.isArray(response)) {
                        handleUpdateStoryData('brainstorm', response, fullPromptForSaving);
                    } else if (response) {
                        setNotification({ message: 'AI returned data in an unexpected format. Please check the console for details and try adjusting your prompt.', type: 'error' });
                        console.error("Invalid JSON response from AI:", response);
                    }
                };

                const handleProceedToOutline = (idea) => {
                    handleUpdateStoryData('outline', idea.fullConcept);
                    setIsBrainstormModalOpen(false);
                    setActiveStage('outline');
                };

                const handleOpenModal = () => {
                    const contentData = {
                        storyTitle: storyTitle,
                        brainstorm: storyData.brainstorm.content,
                        outline: storyData.outline.content,
                        treatment: storyData.treatment.content,
                        write: writeContent,
                        lastPrompt: storyData[activeStage]?.lastPrompt 
                    };
                    onOpenFileActionModal(storyTitle, `story-${activeStage}`, contentData);
                };

                const renderActiveStageContent = () => {
                    if (activeStage === 'brainstorm') {
                        return <BrainstormStage 
                                    storyData={storyData}
                                    storyTraits={storyTraits}
                                    storyAssets={storyAssets}
                                    isLoading={isLoading}
                                    onGenerate={handleGenerateBrainstorm}
                                    onInputChange={handleBrainstormInputChange}
                                    setSelectedIdea={setSelectedIdea}
                                    setIsBrainstormModalOpen={setIsBrainstormModalOpen}
                                />;
                    }
                    if (activeStage === 'outline') {
                        return <OutlineStage storyData={storyData} setStoryData={setStoryData} callGeminiAPI={callGeminiAPI} getAssetContextForAI={getAssetContextForAI} storyAssets={storyAssets} storyTraits={storyTraits} />;
                    }
                    if (activeStage === 'treatment') {
                        return <div>Treatment Stage Content</div>
                    }
                    if (activeStage === 'write') {
                        return <WriteStage 
                                    content={writeContent}
                                    onContentChange={setWriteContent}
                                    undo={undo} redo={redo} canUndo={canUndo} canRedo={canRedo}
                                    callGeminiAPI={callGeminiAPI}
                                />;
                    }
                    return null;
                };

                return (
                     <div className="glass-panel p-6">
                        <div className="border-b border-gray-700 mb-6">
                            <nav className="-mb-px flex space-x-6 justify-start" aria-label="Story Workflow Tabs">
                                {stages.map(stage => (
                                    <button
                                        key={stage.id}
                                        onClick={() => setActiveStage(stage.id)}
                                        className={`main-tab-btn !text-base ${activeStage === stage.id ? 'active' : ''}`}>
                                        {stage.name}
                                    </button>
                                ))}
                            </nav>
                        </div>
                        <ResizableColumns
                            leftColumn={
                                <div className="space-y-8">
                                     <EditableTitleWithFileAction
                                         title={storyTitle}
                                         setTitle={setStoryTitle}
                                         onOpenModal={handleOpenModal}
                                     />
                                     <StoryTraits traits={storyTraits} setTraits={setStoryTraits} />
                                     <AssetManager title="Story Assets" assets={storyAssets} setAssets={setStoryAssets} setNotification={setNotification} />
                                </div>
                            }
                            rightColumn={
                                <div>
                                    {renderActiveStageContent()}
                                    {isBrainstormModalOpen && selectedIdea && (
                                        <BrainstormDetailModal
                                            idea={selectedIdea}
                                            onClose={() => setIsBrainstormModalOpen(false)}
                                            onProceed={handleProceedToOutline}
                                        />
                                    )}
                                </div>
                            }
                        />
                    </div>
                );
            };
            
            const BrainstormStage = ({ storyData, storyTraits, storyAssets, isLoading, onGenerate, onInputChange, setSelectedIdea, setIsBrainstormModalOpen }) => {
                 const { prompt, content: ideas, numIdeas, swot, sixHats } = storyData.brainstorm;
                 
                 const IdeaCard = ({ idea, onClick }) => (
                    <button onClick={onClick} className="glass-panel p-4 text-left hover:border-blue-500 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <h3 className="font-bold text-blue-400 text-lg">{idea.title}</h3>
                        <p className="text-sm text-gray-400 mt-2">{idea.summary}</p>
                    </button>
                 );

                 const SocraticDialogueView = () => {
                     // Placeholder for the guided chat interface
                     return (
                        <div className="glass-panel p-4 text-center">
                            <h3 className="font-semibold text-lg text-gray-400">Socratic Dialogue</h3>
                            <p className="text-sm text-gray-500 mt-2">This interactive feature is under development.</p>
                        </div>
                     );
                };
                
                const FreeWriteView = () => {
                    const [timer, setTimer] = useState(300); // 5 minutes
                    const [isActive, setIsActive] = useState(false);
                    const [text, setText] = useState('');
                    
                    useEffect(() => {
                        let interval = null;
                        if (isActive && timer > 0) {
                            interval = setInterval(() => {
                                setTimer(seconds => seconds - 1);
                            }, 1000);
                        } else if (!isActive && timer !== 0) {
                            clearInterval(interval);
                        } else if (timer === 0) {
                            setIsActive(false);
                        }
                        return () => clearInterval(interval);
                    }, [isActive, timer]);

                    const formatTime = (time) => {
                        const minutes = Math.floor(time / 60);
                        const seconds = time % 60;
                        return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    };

                    return (
                        <div className="glass-panel p-4 space-y-4">
                            <div className="flex justify-between items-center">
                                <h3 className="font-semibold text-lg text-gray-300">Free Writing Session</h3>
                                <div className="text-2xl font-mono text-purple-400">{formatTime(timer)}</div>
                            </div>
                            <textarea
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                placeholder="Start writing freely. Don't stop until the timer runs out..."
                                className="tool-input w-full"
                                rows="10"
                                disabled={!isActive && text !== ''}
                            />
                            <div className="flex gap-4">
                                <button onClick={() => setIsActive(!isActive)} className="btn-primary w-full py-2">
                                    {isActive ? 'Pause' : 'Start'}
                                </button>
                                <button onClick={() => { setTimer(300); setText(''); setIsActive(false); }} className="btn-secondary w-full py-2">
                                    Reset
                                </button>
                            </div>
                        </div>
                    );
                };

                const SWOTAnalysisView = () => (
                    <div className="glass-panel p-4 space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                               <label className="block text-sm font-medium text-green-400 mb-1">Strengths</label>
                               <textarea value={swot.s} onChange={e => onInputChange('swot', {...swot, s: e.target.value})} className="tool-input" rows={3} placeholder="Internal factors that are favorable..."/>
                           </div>
                           <div>
                               <label className="block text-sm font-medium text-red-400 mb-1">Weaknesses</label>
                               <textarea value={swot.w} onChange={e => onInputChange('swot', {...swot, w: e.target.value})} className="tool-input" rows={3} placeholder="Internal factors that are unfavorable..."/>
                           </div>
                           <div>
                               <label className="block text-sm font-medium text-blue-400 mb-1">Opportunities</label>
                               <textarea value={swot.o} onChange={e => onInputChange('swot', {...swot, o: e.target.value})} className="tool-input" rows={3} placeholder="External factors that can be exploited..."/>
                           </div>
                           <div>
                               <label className="block text-sm font-medium text-yellow-400 mb-1">Threats</label>
                               <textarea value={swot.t} onChange={e => onInputChange('swot', {...swot, t: e.target.value})} className="tool-input" rows={3} placeholder="External factors that could cause trouble..."/>
                           </div>
                        </div>
                    </div>
                );
                
                const SixThinkingHatsView = () => {
                    const personas = storyAssets.filter(a => a.type === 'json' && a.content?.name).map(a => a.content.name);
                    const hats = [
                        { id: 'white', name: 'White Hat (Facts)', color: 'bg-gray-200 text-black'},
                        { id: 'red', name: 'Red Hat (Emotions)', color: 'bg-red-500 text-white'},
                        { id: 'black', name: 'Black Hat (Judgment)', color: 'bg-black text-white'},
                        { id: 'yellow', name: 'Yellow Hat (Optimism)', color: 'bg-yellow-400 text-black'},
                        { id: 'green', name: 'Green Hat (Creativity)', color: 'bg-green-500 text-white'},
                        { id: 'blue', name: 'Blue Hat (Process)', color: 'bg-blue-500 text-white'},
                    ];

                    const handleHatChange = (hatId, field, value) => {
                        onInputChange('sixHats', { ...sixHats, [hatId]: { ...sixHats[hatId], [field]: value } });
                    };

                    return (
                        <div className="glass-panel p-4 space-y-4">
                             {hats.map(hat => (
                                <div key={hat.id} className="p-3 rounded-lg border border-gray-700">
                                    <div className="flex items-center justify-between mb-2">
                                        <label htmlFor={`hat-toggle-${hat.id}`} className={`font-bold text-sm px-2 py-1 rounded ${hat.color}`}>{hat.name}</label>
                                        <input type="checkbox" id={`hat-toggle-${hat.id}`} checked={sixHats[hat.id].e} onChange={e => handleHatChange(hat.id, 'e', e.target.checked)} className="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600" />
                                    </div>
                                    {sixHats[hat.id].e && (
                                        <div className="space-y-2">
                                            <textarea 
                                                value={sixHats[hat.id].g}
                                                onChange={e => handleHatChange(hat.id, 'g', e.target.value)}
                                                className="tool-input !min-h-[60px]" 
                                                rows={2}
                                                placeholder={`Guidance for ${hat.name}...`}
                                            />
                                            <select value={sixHats[hat.id].p} onChange={e => handleHatChange(hat.id, 'p', e.target.value)} className="tool-input !min-h-0 py-2 w-full bg-[#0d1117]">
                                                <option value="default">Default (Neutral AI)</option>
                                                {personas.map(p => <option key={p} value={p}>{p}</option>)}
                                            </select>
                                        </div>
                                    )}
                                </div>
                             ))}
                        </div>
                    );
                };


                 const GenerationView = () => (
                    <>
                        <div className="glass-panel p-4 space-y-4">
                            <div>
                                <label htmlFor="brainstorm-prompt" className="block text-sm font-medium text-gray-300 mb-2">Prompt Guidance</label>
                                <textarea
                                    id="brainstorm-prompt"
                                    value={prompt}
                                    onChange={(e) => onInputChange('prompt', e.target.value)}
                                    placeholder="Enter a theme, concept, or problem..."
                                    className="tool-input w-full"
                                    rows="4"
                                />
                            </div>
                             <div>
                                <label htmlFor="num-ideas" className="block text-sm font-medium text-gray-300 mb-2">Number of Ideas to Generate</label>
                                <input
                                    type="number"
                                    id="num-ideas"
                                    value={numIdeas}
                                    onChange={(e) => onInputChange('numIdeas', parseInt(e.target.value, 10))}
                                    className="tool-input w-full"
                                    min="1"
                                    max="12"
                                />
                            </div>
                            <button onClick={onGenerate} disabled={isLoading} className="btn-primary w-full py-2 rounded-md font-semibold flex items-center justify-center">
                                {isLoading ? <div className="loader"></div> : 'Generate Brainstorm'}
                            </button>
                        </div>
                         <div className="mt-8">
                            {isLoading && <div className="flex justify-center"><div className="loader"></div></div>}
                            {ideas && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {ideas.map((idea, index) => (
                                        <IdeaCard key={index} idea={idea} onClick={() => { setSelectedIdea(idea); setIsBrainstormModalOpen(true); }} />
                                    ))}
                                </div>
                            )}
                        </div>
                    </>
                 );

                 const renderContent = () => {
                    const isAnalytical = ['SWOT Analysis', 'Six Thinking Hats'].includes(storyTraits.brainstormType);

                    const analyticalContent = () => {
                        switch(storyTraits.brainstormType) {
                            case 'SWOT Analysis': return <SWOTAnalysisView />;
                            case 'Six Thinking Hats': return <SixThinkingHatsView />;
                            default: return null;
                        }
                    };
                    
                    const creativeContent = () => {
                         switch(storyTraits.brainstormType) {
                            case 'Socratic Dialogue': return <SocraticDialogueView />;
                            case 'Free Writing': return <FreeWriteView />;
                            default: return <GenerationView />;
                        }
                    };

                    if (isAnalytical) {
                        return (
                            <>
                                {analyticalContent()}
                                <div className="mt-8">
                                    <GenerationView />
                                </div>
                            </>
                        );
                    }
                    return creativeContent();
                 };

                return (
                     <div className="space-y-8">
                        <div>
                            <h2 className="text-xl font-bold mb-4 text-blue-500">Brainstorm Controls</h2>
                             {renderContent()}
                        </div>
                     </div>
                );
            };
            
            const BrainstormDetailModal = ({ idea, onClose, onProceed }) => {
                 const modalRef = useRef();
                 useOnClickOutside(modalRef, onClose);
                 
                 return (
                     <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                        <div ref={modalRef} className="glass-panel p-6 rounded-lg w-full max-w-2xl relative flex flex-col max-h-[90vh]">
                            <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><CloseIcon /></button>
                            <h2 className="text-3xl font-bold text-blue-400 mb-4 flex-shrink-0">{idea.title}</h2>
                            <div className="overflow-y-auto pr-4 text-gray-300 flex-grow mb-6">
                                <p className="whitespace-pre-wrap">{idea.fullConcept}</p>
                            </div>
                            <div className="flex justify-end gap-4 flex-shrink-0">
                                <button onClick={onClose} className="btn-secondary py-2 px-6 rounded-md font-semibold">Close</button>
                                <button onClick={() => onProceed(idea)} className="btn-primary py-2 px-6 rounded-md font-semibold">Select & Proceed to Outline</button>
                            </div>
                        </div>
                    </div>
                 );
            };
            
            const OutlineStage = ({ storyData, setStoryData, callGeminiAPI, getAssetContextForAI, storyAssets, storyTraits }) => {
                 // Placeholder for Outline stage functionality
                 return (
                     <div className="glass-panel p-4 text-center">
                        <h2 className="text-xl font-bold text-blue-500 mb-4">Outline</h2>
                        <div className="bg-gray-800 p-4 rounded-md min-h-[200px] text-left text-gray-300 whitespace-pre-wrap">
                            {storyData.outline.content || "Your selected concept will appear here to begin outlining."}
                        </div>
                     </div>
                 );
            };


            // --- REUSABLE UI COMPONENTS ---
             const ContentEditable = React.forwardRef(({ html, onChange, ...props }, ref) => {
                const internalRef = useRef();
                const elementRef = ref || internalRef;
                const lastHtml = useRef(html);

                useEffect(() => {
                    if (elementRef.current && html !== elementRef.current.innerHTML) {
                        elementRef.current.innerHTML = html;
                        lastHtml.current = html;
                    }
                }, [html]);

                const handleInput = (e) => {
                    const newHtml = e.currentTarget.innerHTML;
                    if (lastHtml.current !== newHtml) {
                         onChange(newHtml);
                         lastHtml.current = newHtml;
                    }
                };
                
                return <div {...props} ref={elementRef} onInput={handleInput} />;
            });


            const AccordionSection = ({ title, startOpen = false, children, titleClassName="", isOpen: controlledIsOpen, onToggle: controlledOnToggle }) => {
                const [internalIsOpen, setInternalIsOpen] = useState(startOpen);
                
                const isControlled = controlledIsOpen !== undefined;
                const isOpen = isControlled ? controlledIsOpen : internalIsOpen;
                
                const onToggle = isControlled ? controlledOnToggle : () => setInternalIsOpen(!internalIsOpen);

                return (
                    <div className={`accordion-section ${isOpen ? 'open' : ''}`}>
                        <button type="button" className="accordion-header" onClick={onToggle}>
                            <span className={titleClassName}>{title}</span>
                            <ChevronDownIcon />
                        </button>
                        {isOpen && ( <div className="accordion-content">{children}</div>)}
                    </div>
                );
            };

            const AccordionGroup = ({ children }) => {
                const [openId, setOpenId] = useState(null);

                return (
                    <div className="space-y-4">
                        {React.Children.map(children, (child, index) => {
                             if (React.isValidElement(child)) {
                                const id = child.props.title || `accordion-${index}`;
                                return React.cloneElement(child, {
                                    isOpen: id === openId,
                                    onToggle: () => setOpenId(openId === id ? null : id)
                                });
                            }
                            return child;
                        })}
                    </div>
                );
            }

            const InputField = ({ label, placeholder, type = 'text', value, isAi, onValueChange, onToggleAi }) => {
                const InputComponent = type === 'textarea' ? 'textarea' : 'input';
                const labelClass = label === 'NEGATIVE PROMPTS'
                    ? "block text-sm font-bold text-red-400 mb-1"
                    : "block text-sm font-medium text-gray-300 mb-1";

                return (
                    <div>
                        <label className={labelClass}>{label}</label>
                        <div className="flex items-start gap-3">
                            <InputComponent 
                                type={type === 'textarea' ? undefined : 'text'} 
                                placeholder={placeholder} 
                                className="tool-input" 
                                rows={type === 'textarea' ? 2 : undefined}
                                value={value}
                                disabled={isAi}
                                onChange={(e) => onValueChange(e.target.value)}
                            />
                            <button 
                                type="button" 
                                className={`ai-toggle-btn ${isAi ? 'active' : ''}`} 
                                title="Toggle AI Generation" 
                                onClick={onToggleAi}
                            ></button>
                        </div>
                    </div> 
                );
            };
            
            const EditableTitleWithFileAction = ({ title, setTitle, onOpenModal }) => {
                const titleRef = useRef(null);

                // This effect keeps the data-text attribute in sync for the glow effect
                useEffect(() => {
                    if (titleRef.current) {
                        titleRef.current.dataset.text = title;
                    }
                }, [title]);
                
                return (
                    <div className="flex items-center gap-4">
                        <h3 
                            ref={titleRef}
                            contentEditable="true"
                            suppressContentEditableWarning={true}
                            onInput={e => setTitle(e.currentTarget.textContent)}
                            className="editable-title title-animated-gradient font-bold p-1 rounded-md cursor-pointer inline-block"
                            data-text={title}
                        >{title}</h3>
                        <div className="flex items-center gap-2">
                            <button onClick={onOpenModal} className="action-btn p-2 rounded-md" title="File Actions"><FileActionIcon /></button>
                        </div>
                    </div>
                );
            };


            // --- ASSET MANAGEMENT SYSTEM ---
            const AssetManager = ({ title, assets, setAssets, setNotification }) => { 
                const fileInputRef = useRef(null);

                const handleFileSelect = () => {
                    fileInputRef.current.click();
                };

                const handleFileLoad = (event) => {
                    const files = event.target.files;
                    if (!files.length) return;

                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            let type = 'text';
                            let content = e.target.result;

                            if (file.type.startsWith('image/')) {
                                type = 'image';
                            } else if (file.name.endsWith('.json')) {
                                type = 'json';
                                try {
                                    content = JSON.parse(content);
                                } catch (err) {
                                    setNotification({ message: `Error parsing JSON file: ${file.name}`, type: 'error'});
                                    return;
                                }
                            }
                            
                            const newAsset = {
                                id: Date.now() + Math.random(),
                                name: file.name,
                                type: type,
                                content: content,
                                included: true
                            };

                            setAssets(prevAssets => [...prevAssets, newAsset]);
                        };
                        
                        reader.onerror = () => {
                            setNotification({ message: `Error reading file: ${file.name}`, type: 'error'});
                        };

                        if (file.type.startsWith('image/')) {
                            reader.readAsDataURL(file);
                        } else if (file.type === 'application/json' || file.type === 'text/plain' || file.name.endsWith('.md')) {
                            reader.readAsText(file);
                        } else {
                            setNotification({ message: `Unsupported file type: ${file.name}`, type: 'error' });
                        }
                    });
                    
                    event.target.value = null;
                };
                
                const toggleAsset = (id) => { 
                    setAssets(assets.map(asset => asset.id === id ? { ...asset, included: !asset.included } : asset ));
                }; 
                
                return ( 
                    <AccordionSection title={title} titleClassName="text-xl font-bold">
                        <input type="file" ref={fileInputRef} onChange={handleFileLoad} className="hidden" multiple accept="image/*,.json,.txt,.md" />
                        <button onClick={handleFileSelect} className="w-full py-2 px-4 rounded-lg font-semibold btn-secondary mb-4">Load Asset(s)</button>
                        <div className="space-y-2">
                            {assets && assets.map(asset => ( 
                                <div key={asset.id} className="asset-card flex items-center justify-between p-2 rounded-md">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        {asset.type === 'image' 
                                            ? <img src={asset.content} alt={asset.name} className="w-8 h-8 object-cover rounded-sm flex-shrink-0" />
                                            : <div className="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-gray-700 rounded-sm"><FileIcon /></div>
                                        }
                                        <span className="text-sm text-gray-300 truncate">{asset.name}</span>
                                    </div>
                                    <label className="switch flex-shrink-0 ml-2">
                                        <input type="checkbox" checked={asset.included} onChange={() => toggleAsset(asset.id)} />
                                        <span className="slider"></span>
                                    </label>
                                </div>
                            ))}
                        </div>
                    </AccordionSection> 
                );
            };

            const FileActionModal = ({ isOpen, onClose, title, contentType, contentData }) => {
                const modalRef = useRef();
                useOnClickOutside(modalRef, onClose);

                const [printOptions, setPrintOptions] = useState({
                    brainstorm: true, outline: true, treatment: true, write: true,
                    persona: true, scene: true, world: true
                });

                const handlePrintOptionChange = (option) => {
                    setPrintOptions(prev => ({...prev, [option]: !prev[option]}));
                };
                
                const sanitizeFilename = (name) => (name || 'untitled').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const htmlToText = (html) => {
                    if (!html) return '';
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    return temp.textContent || temp.innerText || '';
                };
                

                if (!isOpen) return null;
                
                // NEW: Logic to determine file extension abbreviations for prompts
                const getFileAbbr = (type) => {
                    if (type.startsWith('story-')) return 'story';
                    if (type === 'persona') return 'char';
                    if (type === 'scene') return 'scen';
                    if (type === 'world') return 'sett';
                    return 'file';
                }

                const handleDownload = (format) => {
                    let fileContent = '';
                    let filename = '';
                    const typeAbbr = getFileAbbr(contentType);

                    // NEW: Handle prompt saving
                    if (format === 'prompt.json') {
                        if (!contentData.lastPrompt) {
                            setNotification({ message: 'No prompt available to save for this content.', type: 'error' });
                            return;
                        }
                        filename = `${sanitizeFilename(title)}.${typeAbbr}.prompt.json`;
                        fileContent = JSON.stringify(contentData.lastPrompt, null, 2);
                    } else { // Existing logic for content saving
                        filename = `${sanitizeFilename(title)}.${format}`;
                        const dataToSave = contentType.startsWith('story-')
                            ? {
                                title: contentData.storyTitle,
                                ...contentData
                            }
                            : {
                                title: contentData.title,
                                ...contentData
                            };
                        
                        if (format === 'json') {
                            fileContent = JSON.stringify(dataToSave, null, 2);
                        } else { // txt or md
                            const separator = "\n\n====================\n\n";
                            fileContent += `${dataToSave.title}\n`;
                            if (dataToSave.brainstorm) fileContent += separator + "BRAINSTORM:\n\n" + htmlToText(dataToSave.brainstorm);
                            if (dataToSave.outline) fileContent += separator + "OUTLINE:\n\n" + htmlToText(dataToSave.outline);
                            if (dataToSave.treatment) fileContent += separator + "TREATMENT:\n\n" + htmlToText(dataToSave.treatment);
                            if (dataToSave.write) fileContent += separator + "STORY:\n\n" + htmlToText(dataToSave.write);

                            if(dataToSave.fields) {
                                fileContent += Object.entries(dataToSave.fields).map(([key, field]) => `${(personaFieldsConfig[key] || sceneFieldsConfig[key] || worldFieldsConfig[key]).label}: ${field.value}`).join('\n');
                            }
                            if(dataToSave.generatedContent) {
                                fileContent += separator + "GENERATED CONTENT:\n\n" + htmlToText(dataToSave.generatedContent);
                            }
                        }
                    }

                    const blob = new Blob([fileContent], { type: `application/json;charset=utf-8` });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    onClose();
                };

                const handlePrint = () => {
                    let printContent = `<h1>${title}</h1>`;
                    if (contentType.startsWith('story-')) {
                        if (printOptions.brainstorm && contentData.brainstorm) printContent += `<h2>Brainstorm</h2><div>${contentData.brainstorm}</div>`;
                        if (printOptions.outline && contentData.outline) printContent += `<h2>Outline</h2><div>${contentData.outline}</div>`;
                        if (printOptions.treatment && contentData.treatment) printContent += `<h2>Treatment</h2><div>${contentData.treatment}</div>`;
                        if (printOptions.write && contentData.write) printContent += `<h2>Story</h2><div>${contentData.write}</div>`;
                    } else {
                         if(contentData.fields) {
                            printContent += `<h2>Traits</h2><ul>` + Object.entries(contentData.fields).map(([key, field]) => `<li><strong>${(personaFieldsConfig[key] || sceneFieldsConfig[key] || worldFieldsConfig[key]).label}:</strong> ${field.value}</li>`).join('') + `</ul>`;
                        }
                         if(contentData.generatedContent) {
                            printContent += `<h2>Generated Content</h2><div>${contentData.generatedContent}</div>`;
                        }
                    }

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`<html><head><title>Print - ${title}</title><style>body{font-family: sans-serif; line-height: 1.6;} h1,h2{margin-top: 1.5em;}</style></head><body>${printContent}</body></html>`);
                    printWindow.document.close();
                    printWindow.print();
                    onClose();
                };

                const StoryPrintOptions = () => (
                    <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        {Object.keys(printOptions).filter(k => ['brainstorm', 'outline', 'treatment', 'write'].includes(k)).map(key => (
                             <label key={key} className="flex items-center">
                                <input type="checkbox" checked={printOptions[key]} onChange={() => handlePrintOptionChange(key)} className="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 mr-2" />
                                {key.charAt(0).toUpperCase() + key.slice(1)}
                            </label>
                        ))}
                    </div>
                );

                const ElementPrintOptions = () => (
                     <div className="space-y-2 mb-4">
                        <label className="flex items-center"><input type="checkbox" className="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 mr-2" defaultChecked /> All Sections</label>
                    </div>
                );

                return (
                     <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                        <div className="glass-panel p-6 rounded-lg w-full max-w-md relative" ref={modalRef}>
                            <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><CloseIcon /></button>
                            <h2 className="text-2xl font-bold mb-6">{title}</h2>
                            
                            <div className="space-y-6">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">Save Content</h3>
                                     <div className="flex justify-around">
                                        {['txt', 'md', 'json'].map(f => (
                                            <button key={f} onClick={() => handleDownload(f)} className="px-4 py-2 rounded-md font-semibold w-24 text-center btn-secondary">
                                                {f.toUpperCase()}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                {/* NEW Prompt Saving Section */}
                                {contentData.lastPrompt && (
                                     <div>
                                        <h3 className="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">Save Prompt</h3>
                                        <button onClick={() => handleDownload('prompt.json')} className="w-full py-3 px-4 rounded-lg font-semibold btn-secondary">
                                            Save Prompt as JSON
                                        </button>
                                     </div>
                                )}
                                 <div>
                                    <h3 className="text-lg font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">Print</h3>
                                    {contentType.startsWith('story-') ? <StoryPrintOptions/> : <ElementPrintOptions/>}
                                    <button onClick={handlePrint} className="w-full mt-4 py-3 px-4 rounded-lg font-semibold btn-primary flex items-center justify-center">
                                        <PrintIcon /> Print
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
            
            // --- NEW GEM COMPONENTS ---
            const GemModal = ({ isOpen, onClose, config, currentValue, onSave, traitKey }) => {
                const modalRef = useRef();
                const [customValue, setCustomValue] = useState('');
                useOnClickOutside(modalRef, onClose);

                useEffect(() => {
                    const isCustom = !Object.values(config.options).flat().includes(currentValue);
                    if (isCustom) {
                        setCustomValue(currentValue);
                    } else {
                        setCustomValue('');
                    }
                }, [currentValue, config]);

                if (!isOpen) return null;

                const handleSaveCustom = () => {
                    if (customValue.trim()) {
                        onSave(traitKey, customValue.trim());
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                        <div className="glass-panel p-6 rounded-lg w-full max-w-lg relative" ref={modalRef}>
                            <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><CloseIcon /></button>
                            <h2 className="text-2xl font-bold mb-6">Select {config.title}</h2>
                            <div className="space-y-4">
                                {Object.entries(config.options).map(([groupName, options]) => (
                                    <div key={groupName}>
                                        <h3 className="w-full text-sm font-semibold text-gray-400 mb-2">{groupName}</h3>
                                        <div className="flex flex-wrap gap-2">
                                            {options.map(option => (
                                                <button 
                                                    key={option} 
                                                    onClick={() => onSave(traitKey, option)}
                                                    className={`px-3 py-2 text-sm rounded-md font-semibold ${currentValue === option ? 'btn-primary' : 'btn-secondary'}`}
                                                >
                                                    {option}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            {Object.values(config.options).flat().includes('Other...') && (
                                <div className="mt-6 pt-4 border-t border-gray-700">
                                     <label className="block text-sm font-medium text-gray-300 mb-2">Enter Custom Value</label>
                                     <div className="flex gap-2">
                                        <input 
                                            type="text"
                                            value={customValue}
                                            onChange={(e) => setCustomValue(e.target.value)}
                                            className="tool-input flex-grow !min-h-0 py-2"
                                        />
                                        <button onClick={handleSaveCustom} className="btn-primary py-2 px-4 rounded-lg font-semibold">Save</button>
                                     </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const StoryTraits = ({ traits, setTraits }) => {
                const [modalConfig, setModalConfig] = useState(null);

                const handleGemClick = (traitKey) => {
                    setModalConfig({
                        ...storyTraitsConfig[traitKey],
                        traitKey: traitKey,
                        currentValue: traits[traitKey]
                    });
                };

                const handleSaveTrait = (traitKey, value) => {
                    if (value === 'Other...') {
                        setTraits(prev => ({ ...prev, [traitKey]: '' }));
                    } else {
                        setTraits(prev => ({ ...prev, [traitKey]: value }));
                        setModalConfig(null);
                    }
                };
                
                const allTraits = Object.keys(storyTraitsConfig);

                return (
                    <div>
                        <AccordionSection title="Guidance" startOpen={true}>
                            <p className="text-xs text-gray-400 mb-3">Define optional parameters to guide the AI.</p>
                            <div className="gem-row">
                                {allTraits.map(key => (
                                    <button key={key} onClick={() => handleGemClick(key)} className="gem-button">
                                        <span className="label">{storyTraitsConfig[key].title}:</span>
                                        <span className="value">{traits[key] || 'Not Set'}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="mt-4">
                                <label className="block text-sm font-bold text-red-400 mb-1">NEGATIVE PROMPTS</label>
                                <textarea
                                    value={traits.negativePrompts || ''}
                                    onChange={(e) => setTraits(prev => ({...prev, negativePrompts: e.target.value}))}
                                    className="tool-input"
                                    rows="2"
                                    placeholder="e.g., clichs, specific words, boring descriptions..."
                                />
                            </div>
                        </AccordionSection>

                        {modalConfig && (
                            <GemModal 
                                isOpen={!!modalConfig}
                                onClose={() => setModalConfig(null)}
                                config={modalConfig}
                                currentValue={modalConfig.currentValue}
                                onSave={handleSaveTrait}
                                traitKey={modalConfig.traitKey}
                            />
                        )}
                    </div>
                );
            };


            // --- ELEMENTS VIEW & COMPONENTS ---
            const ElementsView = ({ setNotification, onOpenFileActionModal, callGeminiAPI }) => { 
                const [activeElementTab, setActiveElementTab] = useState('persona'); 
                const [personaAssets, setPersonaAssets] = useState([]);
                const [sceneAssets, setSceneAssets] = useState([]);
                const [worldAssets, setWorldAssets] = useState([]);

                const renderActiveElementView = () => { 
                    switch (activeElementTab) { 
                        case 'world': return <WorldView setNotification={setNotification} assets={worldAssets} setAssets={setWorldAssets} onOpenFileActionModal={onOpenFileActionModal} callGeminiAPI={callGeminiAPI} />; 
                        case 'scene': return <SceneView setNotification={setNotification} assets={sceneAssets} setAssets={setSceneAssets} onOpenFileActionModal={onOpenFileActionModal} callGeminiAPI={callGeminiAPI} />; 
                        case 'persona': return <PersonaView setNotification={setNotification} assets={personaAssets} setAssets={setPersonaAssets} onOpenFileActionModal={onOpenFileActionModal} callGeminiAPI={callGeminiAPI} />; 
                        default: return <PersonaView setNotification={setNotification} assets={personaAssets} setAssets={setPersonaAssets} onOpenFileActionModal={onOpenFileActionModal} callGeminiAPI={callGeminiAPI} />; 
                    }
                }; 
                return ( 
                    <div className="glass-panel p-6">
                        <div className="border-b border-gray-700 mb-6">
                            <nav className="-mb-px flex space-x-6" aria-label="Element Tabs">
                                <button onClick={() => setActiveElementTab('persona')} className={`main-tab-btn !text-base ${activeElementTab === 'persona' ? 'active' : ''}`}>Persona</button>
                                <button onClick={() => setActiveElementTab('scene')} className={`main-tab-btn !text-base ${activeElementTab === 'scene' ? 'active' : ''}`}>Scene</button>
                                <button onClick={() => setActiveElementTab('world')} className={`main-tab-btn !text-base ${activeElementTab === 'world' ? 'active' : ''}`}>World</button>
                            </nav>
                        </div>
                        <div>{renderActiveElementView()}</div>
                    </div> 
                );
            };
            
            const ConfirmationModal = ({ isOpen, onClose, onConfirm, selectedItems, dontAsk, setDontAsk }) => {
                const modalRef = useRef();
                useOnClickOutside(modalRef, onClose);
                if (!isOpen) return null;

                return (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                        <div className="glass-panel p-6 rounded-lg w-full max-w-md relative" ref={modalRef}>
                             <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><CloseIcon /></button>
                             <h2 className="text-2xl font-bold mb-4">Confirm Reiteration</h2>
                             <ul className="list-disc list-inside bg-gray-900/50 p-3 rounded-md text-gray-300 mb-6">
                                {selectedItems.map(item => <li key={item}>{item}</li>)}
                             </ul>
                             <div className="mb-6">
                                <label className="flex items-center text-sm text-gray-400">
                                    <input type="checkbox" checked={dontAsk} onChange={(e) => setDontAsk(e.target.checked)} className="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 mr-2" />
                                    Do not ask again for this session
                                </label>
                             </div>
                             <div className="flex justify-end gap-4">
                                <button onClick={onClose} className="px-6 py-2 rounded-md font-semibold btn-secondary">Cancel</button>
                                <button onClick={onConfirm} className="px-6 py-2 rounded-md font-semibold btn-primary">Confirm</button>
                             </div>
                        </div>
                    </div>
                );
            };

            const EditorModeSwitch = ({ mode, setMode }) => {
                const modes = ['Lock', 'Edit', 'AI Edit'];
                return (
                    <div className="editor-mode-switch">
                        {modes.map(m => (
                            <button
                                key={m}
                                onClick={() => setMode(m.toLowerCase().replace(' ', '-'))}
                                className={`px-3 py-1 text-sm font-semibold transition-colors ${
                                    mode === m.toLowerCase().replace(' ', '-')
                                        ? 'bg-blue-800 text-white'
                                        : 'text-gray-400 hover:bg-gray-700'
                                }`}
                            >
                                {m}
                            </button>
                        ))}
                    </div>
                );
            };
            
            const UndoRedoControls = ({ onUndo, onRedo, canUndo, canRedo }) => {
                return (
                    <div className="flex items-center gap-2">
                        <button onClick={onUndo} disabled={!canUndo} className="p-2 rounded-md btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                            <UndoIcon />
                        </button>
                        <button onClick={onRedo} disabled={!canRedo} className="p-2 rounded-md btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                            <RedoIcon />
                        </button>
                    </div>
                );
            };

            const AiActionToolbar = ({ position, onAction }) => {
                if (!position.visible) return null;
                return (
                    <div className="ai-action-toolbar" style={{ top: position.top, left: position.left }}>
                        <button onClick={() => onAction('rewrite')}>Rewrite</button>
                        <button onClick={() => onAction('expand')}>Expand</button>
                        <button onClick={() => onAction('ask')}>Ask AI...</button>
                    </div>
                );
            };

            const EditableCanvas = ({ initialContent, onContentChange, placeholder, setNotification, callGeminiAPI }) => {
                const [mode, setMode] = useState('lock');
                const [content, setContent, undo, redo, canUndo, canRedo] = useHistoryState(initialContent || '');
                const [toolbarState, setToolbarState] = useState({ visible: false, top: 0, left: 0 });
                const [isLoading, setIsLoading] = useState(false);

                useEffect(() => {
                    if (initialContent !== content) {
                         setContent(initialContent || '', true);
                    }
                }, [initialContent]);

                useEffect(() => {
                    onContentChange(content);
                }, [content]);

                const handleMouseUp = () => {
                    if (mode !== 'ai-edit') {
                        if (toolbarState.visible) setToolbarState({ visible: false });
                        return;
                    }
                    const selection = window.getSelection();
                    if (selection && !selection.isCollapsed) {
                        const range = selection.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        setToolbarState({
                            visible: true,
                            top: rect.top - 50 + window.scrollY,
                            left: rect.left + (rect.width / 2) + window.scrollX,
                        });
                    } else {
                        setToolbarState({ visible: false });
                    }
                };

                const handleAiAction = async (action) => {
                    const selection = window.getSelection();
                    if (!selection.isCollapsed) {
                        const selectedText = selection.toString();
                        let prompt = "";
                        if(action === 'rewrite') {
                            prompt = `Rewrite the following text: "${selectedText}"`;
                        } else if(action === 'expand') {
                            prompt = `Expand upon the following text: "${selectedText}"`;
                        } else {
                            const customInstruction = window.prompt("Enter your instruction for the AI:");
                            if(customInstruction) {
                                prompt = `${customInstruction}: "${selectedText}"`;
                            } else {
                                return;
                            }
                        }
                        
                        const response = await callGeminiAPI(prompt, setIsLoading);
                        if (response && !response.startsWith("Error:")) {
                           document.execCommand('insertHTML', false, response);
                        }
                    }
                    setToolbarState({ visible: false });
                };
                
                const hasContent = content && content.trim() !== '';

                return (
                    <div onMouseUp={handleMouseUp}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-blue-500">Generated Content</h2>
                            <div className="flex items-center gap-4">
                                {(mode === 'edit' || mode === 'ai-edit') && (
                                     <UndoRedoControls onUndo={undo} onRedo={redo} canUndo={canUndo} canRedo={canRedo} />
                                )}
                                <EditorModeSwitch mode={mode} setMode={setMode} />
                            </div>
                        </div>
                        <AiActionToolbar position={toolbarState} onAction={handleAiAction} />
                        <div className="glass-panel p-6 min-h-[200px] text-gray-300">
                             {hasContent ? (
                                <div className="content-editable-wrapper" data-mode={mode}>
                                    <ContentEditable 
                                        className="text-gray-400"
                                        html={content}
                                        mode={mode}
                                        onChange={setContent}
                                    />
                                </div>
                            ) : (
                                <div className="flex items-center justify-center h-full text-gray-500">
                                    {placeholder}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const WriteStage = ({ content, onContentChange, undo, redo, canUndo, canRedo, callGeminiAPI }) => {
                const [writeMode, setWriteMode] = useState('lock');
                const [toolbarState, setToolbarState] = useState({ visible: false, top: 0, left: 0 });
                const [isLoading, setIsLoading] = useState(false);
                
                const handleMouseUp = () => {
                    if (writeMode !== 'ai-edit') {
                         if(toolbarState.visible) setToolbarState({ visible: false });
                        return;
                    }
                    const selection = window.getSelection();
                    if (selection && !selection.isCollapsed) {
                        const range = selection.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        setToolbarState({
                            visible: true,
                            top: rect.top - 50 + window.scrollY,
                            left: rect.left + (rect.width / 2) + window.scrollX,
                        });
                    } else {
                        setToolbarState({ visible: false });
                    }
                };
                 const handleAiAction = async (action) => {
                    const selection = window.getSelection();
                    if (!selection.isCollapsed) {
                        const selectedText = selection.toString();
                        let prompt = "";
                        if(action === 'rewrite') {
                            prompt = `Rewrite the following text: "${selectedText}"`;
                        } else if(action === 'expand') {
                            prompt = `Expand upon the following text: "${selectedText}"`;
                        } else {
                            const customInstruction = window.prompt("Enter your instruction for the AI:");
                            if(customInstruction) {
                                prompt = `${customInstruction}: "${selectedText}"`;
                            } else {
                                return;
                            }
                        }
                        
                        const response = await callGeminiAPI(prompt, setIsLoading);
                        if (response && !response.startsWith("Error:")) {
                           document.execCommand('insertHTML', false, response);
                        }
                    }
                    setToolbarState({ visible: false });
                };

                return (
                    <div onMouseUp={handleMouseUp}>
                        <AiActionToolbar position={toolbarState} onAction={handleAiAction} />
                        <div className="glass-panel">
                            <div className="flex border-b border-gray-700 justify-between items-center p-2">
                                <h2 className="text-2xl font-semibold text-white ml-4">Your Story</h2>
                                <div className="flex items-center gap-4">
                                    {(writeMode === 'edit' || writeMode === 'ai-edit') && (
                                         <UndoRedoControls onUndo={undo} onRedo={redo} canUndo={canUndo} canRedo={canRedo} />
                                    )}
                                    <EditorModeSwitch mode={writeMode} setMode={setWriteMode} />
                                </div>
                            </div>
                            <div className="p-6">
                                <p className="text-sm text-gray-400 mb-4">This is your main writing space.</p>
                                <div className="content-editable-wrapper relative w-full min-h-[70vh] p-4 bg-gray-900 text-gray-300 border border-gray-700 rounded-lg" data-mode={writeMode}>
                                    <ContentEditable
                                        html={content}
                                        mode={writeMode}
                                        onChange={onContentChange}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const PersonaView = ({ setNotification, assets, setAssets, onOpenFileActionModal, callGeminiAPI }) => {
                const [personaTitle, setPersonaTitle] = useState('Untitled Persona');
                const [promptGuidance, setPromptGuidance] = useState('');
                const [generatedContent, setGeneratedContent] = useState(null);
                const [isLoading, setIsLoading] = useState(false);
                const [lastGeneratedPrompt, setLastGeneratedPrompt] = useState(null);

                const initialFieldsState = Object.keys(personaFieldsConfig).reduce((acc, key) => {
                    acc[key] = { value: '', isAi: key === 'name' }; // Default 'name' to AI-generated
                    return acc;
                }, {});

                const [fields, setFields] = useState(initialFieldsState);
                
                const getAssetContextForAI = (assets) => {
                    if (!assets) return "";
                    const includedAssets = assets.filter(asset => asset.included);
                    if (includedAssets.length === 0) return "";

                    let context = "\n\n--- ASSETS CONTEXT ---\n";
                    includedAssets.forEach(asset => {
                        context += `\n[File: ${asset.name}]\n`;
                        if (asset.type === 'json') {
                            context += `Content: ${JSON.stringify(asset.content, null, 2)}\n`;
                        } else {
                            context += `Content: ${asset.content}\n`;
                        }
                    });
                    context += "--- END ASSETS CONTEXT ---\n";
                    return context;
                };

                const handleFieldChange = (fieldName, newValue) => {
                    setFields(prev => ({
                        ...prev,
                        [fieldName]: { ...prev[fieldName], value: newValue, isAi: false }
                    }));
                };

                const handleToggleAi = (fieldName) => {
                    setFields(prev => ({
                        ...prev,
                        [fieldName]: { ...prev[fieldName], value: '', isAi: !prev[fieldName].isAi }
                    }));
                };

                const handleGenerate = async () => {
                    const activeFields = Object.entries(fields)
                        .filter(([key, data]) => data.value.trim() !== '' || data.isAi)
                        .map(([key, data]) => {
                            const label = personaFieldsConfig[key].label;
                            return `\n- ${label}: ${data.isAi ? '(AI to generate)' : data.value}`;
                        })
                        .join('');
                    
                    const assetContext = getAssetContextForAI(assets);

                    let prompt = `You are an expert character designer. Generate a rich and detailed persona profile.`;
                    
                    prompt += assetContext;
                    
                    if (activeFields) {
                        prompt += `\n\nUSER-PROVIDED TRAITS:\n${activeFields}`;
                    }
                    if (promptGuidance) {
                        prompt += `\n\nADDITIONAL GUIDANCE:\n${promptGuidance}`;
                    }
                    
                    // NEW: Capture the full prompt for saving
                    const fullPromptForSaving = {
                        title: personaTitle,
                        type: 'persona',
                        timestamp: new Date().toISOString(),
                        fullPrompt: prompt,
                        components: {
                            userGuidance: promptGuidance,
                            activeFields: fields,
                            assetContext: assetContext
                        }
                    };
                    setLastGeneratedPrompt(fullPromptForSaving);
                    
                    const response = await callGeminiAPI(prompt, setIsLoading);
                     if (response && !response.startsWith("Error:")) {
                        setGeneratedContent(response);
                    }
                };

                const handleOpenModal = () => {
                    const contentData = {
                        title: personaTitle,
                        fields: fields,
                        generatedContent: generatedContent,
                        lastPrompt: lastGeneratedPrompt
                    };
                    onOpenFileActionModal(personaTitle, 'persona', contentData);
                };

                return (
                     <ResizableColumns
                        leftColumn={
                            <div className="space-y-8">
                               <EditableTitleWithFileAction
                                    title={personaTitle}
                                    setTitle={setPersonaTitle}
                                    onOpenModal={handleOpenModal}
                                />
                                
                                <AccordionSection title="Persona Traits" startOpen={true} titleClassName="text-xl font-bold">
                                    <AccordionGroup>
                                        <AccordionSection title="Core Concept">
                                            <div className="space-y-4">
                                                {['name', 'genre', 'core-description'].map(key => (
                                                    <InputField key={key} label={personaFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={personaFieldsConfig[key].placeholder} type={personaFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Personal History">
                                            <div className="space-y-4">
                                                 {['backstory', 'motivations', 'goals'].map(key => (
                                                    <InputField key={key} label={personaFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={personaFieldsConfig[key].placeholder} type={personaFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Abilities & Traits">
                                            <div className="space-y-4">
                                                {['personality', 'weaknesses', 'skills', 'abilities', 'equipment'].map(key => (
                                                    <InputField key={key} label={personaFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={personaFieldsConfig[key].placeholder} type={personaFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Relationships & Notes">
                                            <div className="space-y-4">
                                                {['relationships', 'notes'].map(key => (
                                                    <InputField key={key} label={personaFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={personaFieldsConfig[key].placeholder} type={personaFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Appearance">
                                            <div className="space-y-4">
                                                {['gender', 'build', 'hair', 'eyes', 'clothing', 'expression', 'background', 'other-details', 'negative-prompts'].map(key => (
                                                    <InputField key={key} label={personaFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={personaFieldsConfig[key].placeholder} type={personaFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                    </AccordionGroup>
                                </AccordionSection>

                                <AssetManager title="Persona Assets" assets={assets} setAssets={setAssets} setNotification={setNotification} />
                            </div>
                        }
                        rightColumn={
                            <div className="space-y-8">
                                 <div>
                                    <h2 className="text-xl font-bold mb-4 text-blue-500">Generation Controls</h2>
                                    <div className="glass-panel p-4 space-y-4">
                                         <div>
                                             <label htmlFor="prompt-guidance" className="block text-sm font-medium text-gray-300 mb-2">Prompt Guidance (Optional)</label>
                                             <textarea
                                                id="prompt-guidance"
                                                value={promptGuidance}
                                                onChange={(e) => setPromptGuidance(e.target.value)}
                                                placeholder="e.g., Make the backstory tragic..."
                                                className="tool-input w-full"
                                                rows="4"
                                             />
                                        </div>
                                        <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-2 rounded-md font-semibold flex items-center justify-center">
                                            {isLoading ? <div className="loader"></div> : 'Generate Profile'}
                                        </button>
                                    </div>
                                </div>
                                <EditableCanvas 
                                    initialContent={generatedContent} 
                                    onContentChange={setGeneratedContent}
                                    setNotification={setNotification}
                                    placeholder="Your generated persona profile will appear here."
                                    callGeminiAPI={callGeminiAPI}
                                 />
                            </div>
                        }
                    />
                );
            }

            const SceneView = ({ setNotification, assets, setAssets, onOpenFileActionModal, callGeminiAPI }) => {
                const [sceneTitle, setSceneTitle] = useState('Untitled Scene');
                const [promptGuidance, setPromptGuidance] = useState('');
                const [generatedContent, setGeneratedContent] = useState(null);
                const [isLoading, setIsLoading] = useState(false);
                const [lastGeneratedPrompt, setLastGeneratedPrompt] = useState(null);

                const initialFieldsState = Object.keys(sceneFieldsConfig).reduce((acc, key) => {
                    acc[key] = { value: '', isAi: key === 'name' };
                    return acc;
                }, {});
                const [fields, setFields] = useState(initialFieldsState);
                
                const getAssetContextForAI = (assets) => {
                    if (!assets) return "";
                    const includedAssets = assets.filter(asset => asset.included);
                    if (includedAssets.length === 0) return "";
                    let context = "\n\n--- ASSETS CONTEXT ---\n";
                    includedAssets.forEach(asset => {
                        context += `\n[File: ${asset.name}]\n`;
                        if (asset.type === 'json') {
                            context += `Content: ${JSON.stringify(asset.content, null, 2)}\n`;
                        } else {
                            context += `Content: ${asset.content}\n`;
                        }
                    });
                    context += "--- END ASSETS CONTEXT ---\n";
                    return context;
                };

                const handleFieldChange = (fieldName, newValue) => {
                    setFields(prev => ({ ...prev, [fieldName]: { ...prev[fieldName], value: newValue, isAi: false } }));
                };

                const handleToggleAi = (fieldName) => {
                    setFields(prev => ({ ...prev, [fieldName]: { ...prev[fieldName], value: '', isAi: !prev[fieldName].isAi } }));
                };

                const handleGenerate = async () => {
                     const activeFields = Object.entries(fields)
                        .filter(([key, data]) => data.value.trim() !== '' || data.isAi)
                        .map(([key, data]) => `\n- ${sceneFieldsConfig[key].label}: ${data.isAi ? '(AI to generate)' : data.value}`)
                        .join('');
                    
                    const assetContext = getAssetContextForAI(assets);
                    
                    let prompt = `You are a master storyteller and production designer. Generate a rich and detailed scene profile.`;
                    prompt += assetContext;
                    if (activeFields) prompt += `\n\nUSER-PROVIDED DETAILS:\n${activeFields}`;
                    if (promptGuidance) prompt += `\n\nADDITIONAL GUIDANCE:\n${promptGuidance}`;

                    const fullPromptForSaving = {
                        title: sceneTitle,
                        type: 'scene',
                        timestamp: new Date().toISOString(),
                        fullPrompt: prompt,
                        components: {
                            userGuidance: promptGuidance,
                            activeFields: fields,
                            assetContext: assetContext
                        }
                    };
                    setLastGeneratedPrompt(fullPromptForSaving);

                    const response = await callGeminiAPI(prompt, setIsLoading);
                     if (response && !response.startsWith("Error:")) {
                        setGeneratedContent(response);
                    }
                };

                const handleOpenModal = () => {
                    const contentData = {
                        title: sceneTitle,
                        fields: fields,
                        generatedContent: generatedContent,
                        lastPrompt: lastGeneratedPrompt
                    };
                    onOpenFileActionModal(sceneTitle, 'scene', contentData);
                };

                return (
                    <ResizableColumns
                        leftColumn={
                            <div className="space-y-8">
                                <EditableTitleWithFileAction title={sceneTitle} setTitle={setSceneTitle} onOpenModal={handleOpenModal} />
                                <AccordionSection title="Scene Traits" startOpen={true} titleClassName="text-xl font-bold">
                                    <AccordionGroup>
                                        <AccordionSection title="Core Concept">
                                            <div className="space-y-4">
                                                {['name', 'genre', 'overview'].map(key => (
                                                    <InputField key={key} label={sceneFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={sceneFieldsConfig[key].placeholder} type={sceneFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Sensory Details">
                                            <div className="space-y-4">
                                                {['atmosphere', 'exterior', 'interior'].map(key => (
                                                    <InputField key={key} label={sceneFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={sceneFieldsConfig[key].placeholder} type={sceneFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                         <AccordionSection title="Context & Setting">
                                            <div className="space-y-4">
                                                {['history'].map(key => (
                                                    <InputField key={key} label={sceneFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={sceneFieldsConfig[key].placeholder} type={sceneFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Visuals & Style">
                                            <div className="space-y-4">
                                                {['time_of_day', 'weather', 'architectural_style', 'other_details', 'negative_prompts_scene'].map(key => (
                                                    <InputField key={key} label={sceneFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={sceneFieldsConfig[key].placeholder} type={sceneFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                    </AccordionGroup>
                                </AccordionSection>
                                <AssetManager title="Scene Assets" assets={assets} setAssets={setAssets} setNotification={setNotification} />
                            </div>
                        }
                        rightColumn={
                            <div className="space-y-8">
                                <div>
                                    <h2 className="text-xl font-bold mb-4 text-blue-500">Generation Controls</h2>
                                    <div className="glass-panel p-4 space-y-4">
                                        <div>
                                            <label htmlFor="scene-prompt-guidance" className="block text-sm font-medium text-gray-300 mb-2">Prompt Guidance (Optional)</label>
                                            <textarea id="scene-prompt-guidance" value={promptGuidance} onChange={(e) => setPromptGuidance(e.target.value)} placeholder="e.g., Describe the scene in a poetic style..." className="tool-input w-full" rows="4" />
                                        </div>
                                        <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-2 rounded-md font-semibold flex items-center justify-center">
                                            {isLoading ? <div className="loader"></div> : 'Generate Scene Profile'}
                                        </button>
                                    </div>
                                </div>
                                <EditableCanvas 
                                    initialContent={generatedContent} 
                                    onContentChange={setGeneratedContent}
                                    setNotification={setNotification} 
                                    placeholder="Your generated scene profile will appear here."
                                    callGeminiAPI={callGeminiAPI} 
                                />
                            </div>
                        }
                    />
                );
            };

            const WorldView = ({ setNotification, assets, setAssets, onOpenFileActionModal, callGeminiAPI }) => {
                const [worldTitle, setWorldTitle] = useState('Untitled World');
                const [promptGuidance, setPromptGuidance] = useState('');
                const [generatedContent, setGeneratedContent] = useState(null);
                const [isLoading, setIsLoading] = useState(false);
                const [lastGeneratedPrompt, setLastGeneratedPrompt] = useState(null);

                const initialFieldsState = Object.keys(worldFieldsConfig).reduce((acc, key) => {
                    acc[key] = { value: '', isAi: key === 'name' };
                    return acc;
                }, {});
                const [fields, setFields] = useState(initialFieldsState);
                
                const getAssetContextForAI = (assets) => {
                    if (!assets) return "";
                    const includedAssets = assets.filter(asset => asset.included);
                    if (includedAssets.length === 0) return "";
                    let context = "\n\n--- ASSETS CONTEXT ---\n";
                    includedAssets.forEach(asset => {
                        context += `\n[File: ${asset.name}]\n`;
                        if (asset.type === 'json') {
                            context += `Content: ${JSON.stringify(asset.content, null, 2)}\n`;
                        } else {
                            context += `Content: ${asset.content}\n`;
                        }
                    });
                    context += "--- END ASSETS CONTEXT ---\n";
                    return context;
                };

                const handleFieldChange = (fieldName, newValue) => {
                    setFields(prev => ({ ...prev, [fieldName]: { ...prev[fieldName], value: newValue, isAi: false } }));
                };

                const handleToggleAi = (fieldName) => {
                    setFields(prev => ({ ...prev, [fieldName]: { ...prev[fieldName], value: '', isAi: !prev[fieldName].isAi } }));
                };

                const handleGenerate = async () => {
                    const activeFields = Object.entries(fields)
                       .filter(([key, data]) => data.value.trim() !== '' || data.isAi)
                       .map(([key, data]) => `\n- ${worldFieldsConfig[key].label}: ${data.isAi ? '(AI to generate)' : data.value}`)
                       .join('');
                    
                    const assetContext = getAssetContextForAI(assets);

                    let prompt = `You are a master world-builder. Generate a rich and detailed world profile.`;
                    prompt += assetContext;
                    if (activeFields) prompt += `\n\nUSER-PROVIDED DETAILS:\n${activeFields}`;
                    if (promptGuidance) prompt += `\n\nADDITIONAL GUIDANCE:\n${promptGuidance}`;
                   
                    const fullPromptForSaving = {
                        title: worldTitle,
                        type: 'world',
                        timestamp: new Date().toISOString(),
                        fullPrompt: prompt,
                        components: {
                            userGuidance: promptGuidance,
                            activeFields: fields,
                            assetContext: assetContext
                        }
                    };
                    setLastGeneratedPrompt(fullPromptForSaving);

                   const response = await callGeminiAPI(prompt, setIsLoading);
                     if (response && !response.startsWith("Error:")) {
                        setGeneratedContent(response);
                    }
                };

                const handleOpenModal = () => {
                    const contentData = {
                        title: worldTitle,
                        fields: fields,
                        generatedContent: generatedContent,
                        lastPrompt: lastGeneratedPrompt
                    };
                    onOpenFileActionModal(worldTitle, 'world', contentData);
                };

                return (
                    <ResizableColumns
                        leftColumn={
                            <div className="space-y-8">
                                <EditableTitleWithFileAction title={worldTitle} setTitle={setWorldTitle} onOpenModal={handleOpenModal} />
                                <AccordionSection title="World Traits" startOpen={true} titleClassName="text-xl font-bold">
                                    <AccordionGroup>
                                        <AccordionSection title="Core Concept">
                                            <div className="space-y-4">
                                                {['name', 'genre', 'timePeriod', 'corePremise'].map(key => (
                                                    <InputField key={key} label={worldFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={worldFieldsConfig[key].placeholder} type={worldFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Physical Environment">
                                            <div className="space-y-4">
                                                {['geography', 'climate', 'floraFauna'].map(key => (
                                                    <InputField key={key} label={worldFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={worldFieldsConfig[key].placeholder} type={worldFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Society & Culture">
                                            <div className="space-y-4">
                                                {['population', 'government', 'economy', 'culture'].map(key => (
                                                    <InputField key={key} label={worldFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={worldFieldsConfig[key].placeholder} type={worldFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Systems & Rules">
                                            <div className="space-y-4">
                                                {['technology', 'magic', 'religion'].map(key => (
                                                    <InputField key={key} label={worldFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={worldFieldsConfig[key].placeholder} type={worldFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="History & Lore">
                                            <div className="space-y-4">
                                                {['history', 'lore'].map(key => (
                                                    <InputField key={key} label={worldFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={worldFieldsConfig[key].placeholder} type={worldFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                        <AccordionSection title="Visuals & Style">
                                            <div className="space-y-4">
                                                {['architectural_style_world', 'time_of_day_world', 'weather_vis', 'other_details_vis', 'negative_prompts_setting'].map(key => (
                                                    <InputField key={key} label={worldFieldsConfig[key].label} value={fields[key].value} isAi={fields[key].isAi} onValueChange={(val) => handleFieldChange(key, val)} onToggleAi={() => handleToggleAi(key)} placeholder={worldFieldsConfig[key].placeholder} type={worldFieldsConfig[key].type} />
                                                ))}
                                            </div>
                                        </AccordionSection>
                                    </AccordionGroup>
                                </AccordionSection>
                                <AssetManager title="World Assets" assets={assets} setAssets={setAssets} setNotification={setNotification} />
                            </div>
                        }
                        rightColumn={
                            <div className="space-y-8">
                                <div>
                                    <h2 className="text-xl font-bold mb-4 text-blue-500">Generation Controls</h2>
                                    <div className="glass-panel p-4 space-y-4">
                                        <div>
                                            <label htmlFor="world-prompt-guidance" className="block text-sm font-medium text-gray-300 mb-2">Prompt Guidance (Optional)</label>
                                            <textarea id="world-prompt-guidance" value={promptGuidance} onChange={(e) => setPromptGuidance(e.target.value)} placeholder="e.g., Emphasize the magical elements, write in a dark fantasy tone..." className="tool-input w-full" rows="4" />
                                        </div>
                                        <button onClick={handleGenerate} disabled={isLoading} className="btn-primary w-full py-2 rounded-md font-semibold flex items-center justify-center">
                                            {isLoading ? <div className="loader"></div> : 'Generate World Profile'}
                                        </button>
                                    </div>
                                </div>
                                <EditableCanvas 
                                    initialContent={generatedContent} 
                                    onContentChange={setGeneratedContent}
                                    setNotification={setNotification} 
                                    placeholder="Your generated world profile will appear here." 
                                    callGeminiAPI={callGeminiAPI}
                                />
                            </div>
                        }
                    />
                );
            };

            const SettingsModal = ({ isOpen, onClose, onSave, currentKey }) => {
                const [localKey, setLocalKey] = useState(currentKey);
                const modalRef = useRef();

                useEffect(() => {
                    setLocalKey(currentKey);
                }, [currentKey]);

                useOnClickOutside(modalRef, onClose);

                if (!isOpen) return null;

                return (
                    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                        <div ref={modalRef} className="glass-panel p-6 rounded-lg w-full max-w-md relative">
                            <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-white"><CloseIcon /></button>
                            <h2 className="text-2xl font-bold mb-4">Settings</h2>
                            <p className="text-sm text-gray-400 mb-4">Your Gemini API key is stored locally in your browser and is never sent to our servers.</p>
                            <div className="space-y-2">
                                <label htmlFor="api-key-input" className="block text-sm font-medium text-gray-300">Google Gemini API Key</label>
                                <input 
                                    type="password" 
                                    id="api-key-input" 
                                    className="tool-input" 
                                    placeholder="Enter your API key"
                                    value={localKey}
                                    onChange={(e) => setLocalKey(e.target.value)}
                                />
                            </div>
                            <button onClick={() => onSave(localKey)} className="mt-6 w-full py-3 px-4 rounded-lg font-semibold btn-primary">Save Key</button>
                        </div>
                    </div>
                );
            };
            
            const Footer = () => ( <footer className="text-center mt-auto py-8"><p className="text-sm text-gray-500">AI.me Pair Writer by Wolfe.BT@TangentLLC</p></footer> );

            return (
                <div className="flex flex-col h-screen">
                    <div className="flex-shrink-0 z-20">
                       <div className="container mx-auto max-w-screen-xl px-4 sm:px-6 lg-px-8">
                            <Header />
                            <MainTabs activeTab={activeMainTab} setActiveTab={setActiveMainTab} />
                        </div>
                    </div>
                    
                    <div className="flex-grow overflow-y-auto">
                        <div className="container mx-auto max-w-screen-xl p-4 sm:p-6 lg:p-8">
                            <main>
                                {activeMainTab === 'story' && <StoryView setNotification={setNotification} onOpenFileActionModal={openFileActionModal} callGeminiAPI={callGeminiAPI} />}
                                {activeMainTab === 'elements' && <ElementsView setNotification={setNotification} onOpenFileActionModal={openFileActionModal} callGeminiAPI={callGeminiAPI} />}
                            </main>
                            <Footer />
                        </div>
                    </div>
                    
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} onSave={handleSaveApiKey} currentKey={apiKey} />
                    <FileActionModal 
                        isOpen={fileActionState.isOpen}
                        onClose={closeFileActionModal}
                        title={fileActionState.title}
                        contentType={fileActionState.contentType}
                        contentData={fileActionState.contentData}
                    />
                    <Notification notification={notification} onClear={clearNotification} />
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

